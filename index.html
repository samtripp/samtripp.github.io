<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flippy V1 Web Controller</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>FlipDot Controller</h1>

  <div class="control">
    <label>USB Port:</label>
    <select id="portSelect"></select>
    <button id="requestPortBtn">Request New Port</button>
  </div>

  <div class="control">
    <label>Address:</label>
    <input type="number" id="address" value="1" min="1" />
  </div>

  <div class="control">
    <label>Width:</label>
    <input type="number" id="width" value="96" min="1" />
    <label>Height:</label>
    <input type="number" id="height" value="16" min="1" />
  </div>

  <div class="control">
    <input type="text" id="textInput" placeholder="Type message" />
    <button id="sendBtn">Send</button>
  </div>

  <pre id="status">Status: Not connected</pre>

  <script type="module">
    import { erase, place, tiny } from './flipHelpers.js';
    import { displayMain, openPort } from './display.js';

    let port;
    let writer;
    let availablePorts = [];

    const statusEl = document.getElementById("status");
    const portSelectEl = document.getElementById("portSelect");

    /** List all previously granted ports */
    async function listPorts() {
      availablePorts = await navigator.serial.getPorts();
      portSelectEl.innerHTML = "";
      availablePorts.forEach((p, idx) => {
        const info = p.getInfo();
        const option = document.createElement("option");
        option.value = idx;
        option.textContent = info.usbVendorId
          ? `SLAB / Vendor: ${info.usbVendorId}`
          : "Unknown port";
        portSelectEl.appendChild(option);
      });
    }

    /** Open selected port */
    async function selectPort(idx) {
      const selectedPort = availablePorts[idx];
      if (!selectedPort) return;
      await openPort(selectedPort);
      statusEl.textContent = "Status: Connected to selected port!";
    }

    /** Request a new port from the user */
    async function requestNewPort() {
      try {
        port = await navigator.serial.requestPort({
          filters: [{ usbVendorId: 0x10c4 }] // optional
        });
        await openPort(port);
        await listPorts(); // refresh dropdown
        statusEl.textContent = "Status: Connected to new port!";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err;
      }
    }

    /** Send text to the display */
    async function sendText() {
      const text = document.getElementById("textInput").value;
      const width = parseInt(document.getElementById("width").value, 10);
      const height = parseInt(document.getElementById("height").value, 10);
      const address = parseInt(document.getElementById("address").value, 10);

      if (!port || !writer) {
        alert("Please connect to a port first!");
        return;
      }

      let flippy = erase(width, height);
      const matrix = tiny(text);
      flippy = place(flippy, matrix, [0, 4], false, width, height);
      await displayMain(flippy, address);
    }

    // Event listeners
    window.addEventListener("load", listPorts);
    portSelectEl.addEventListener("change", e => selectPort(parseInt(e.target.value, 10)));
    document.getElementById("requestPortBtn").addEventListener("click", requestNewPort);
    document.getElementById("sendBtn").addEventListener("click", sendText);
  </script>
</body>
</html>
