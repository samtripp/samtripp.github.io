<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flippy V1 Web Controller</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>FlipDot Controller</h1>

  <div class="control">
    <button id="connect">Connect to Port</button>
  </div>

  <div class="control">
    <label>Address:</label>
    <input type="number" id="address" value="1" min="1" />
  </div>

  <div class="control">
    <label>Width:</label>
    <input type="number" id="width" value="96" min="1" />
    <label>Height:</label>
    <input type="number" id="height" value="16" min="1" />
  </div>

  <div class="control">
    <input type="text" id="textInput" placeholder="Type message" />
    <button id="send">Send</button>
  </div>

  <pre id="status">Status: Not connected</pre>

  <script type="module">
    import { erase, place, tiny } from './flipHelpers.js';
    import { displayMain, openPort } from './display.js';

    let port;
    let writer;

    /** Connect button triggers port selection */
    document.getElementById("connect").addEventListener("click", async () => {
      try {
        port = await navigator.serial.requestPort({ filters: [{ usbVendorId: 0x10c4 }] });
        await openPort(port);
        document.getElementById("status").textContent = "Status: Connected!";
      } catch (err) {
        console.error(err);
        document.getElementById("status").textContent = "Error: " + err;
      }
    });

    /** Send button displays text */
    document.getElementById("send").addEventListener("click", async () => {
      if (!port) {
        alert("Please connect to a port first!");
        return;
      }

      const text = document.getElementById("textInput").value;
      const width = parseInt(document.getElementById("width").value, 10);
      const height = parseInt(document.getElementById("height").value, 10);
      const address = parseInt(document.getElementById("address").value, 10);

      let flippy = erase(width, height);
      const matrix = tiny(text);
      flippy = place(flippy, matrix, [0, 4], false, width, height);
      await displayMain(flippy, address);
    });
  </script>
</body>
</html>
