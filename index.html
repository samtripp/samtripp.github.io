<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flippy V1 Web Controller</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>FlipDot Controller</h1>

  <div class="control">
    <label>USB Port:</label>
    <select id="portSelect"></select>
    <button id="connect">Connect</button>
  </div>

  <div class="control">
    <label>Address:</label>
    <input type="number" id="address" value="1" min="1" />
  </div>

  <div class="control">
    <label>Width:</label>
    <input type="number" id="width" value="96" min="1" />
    <label>Height:</label>
    <input type="number" id="height" value="16" min="1" />
  </div>

  <div class="control">
    <input type="text" id="textInput" placeholder="Type message" />
    <button id="send">Send</button>
  </div>

  <pre id="status">Status: Not connected</pre>

  <script type="module">
    import { erase, place, convert, tiny } from './flipHelpers.js';
    import { displayMain } from './display.js';

    async function listPorts() {
        const ports = await navigator.serial.getPorts();
        const portSelect = document.getElementById("portSelect");
        portSelect.innerHTML = "";
        ports.forEach(p => {
            const option = document.createElement("option");
            option.value = ports.indexOf(p);
            option.textContent = p.getInfo().usbVendorId
            ? `SLAB / Vendor:${p.getInfo().usbVendorId}`
            : "Unknown port";
            portSelect.appendChild(option);
        });
    }

    async function connect() {
        try {
            port = await navigator.serial.requestPort({
                filters: [{ usbVendorId: 0x10c4 }]
            });

            await port.open({ baudRate: 4800 });
            const encoder = new TextEncoderStream();
            encoder.readable.pipeTo(port.writable);
            writer = encoder.writable.getWriter();

            document.getElementById("status").textContent = "Status: Connected!";
        } catch (err) {
            document.getElementById("status").textContent = "Error: " + err;
        }
    }


    const MAXWIDTH = 32;
    const MAXHEIGHT = 16;
    let flippy = Array.from({ length: MAXHEIGHT }, () => Array(MAXWIDTH).fill(0));

    function displayText(text, width, height, port, address,) {
        flippy = Array.from({ length: height }, () => Array(width).fill(0));
        flippy = erase(width, height);
        const matrix = tiny(text);
        flippy = place(flippy, matrix, [0, 4], false, width, height);
        displayMain(flippy, port, address);
    }

    window.addEventListener("load", listPorts);
    
    document.getElementById("connect").addEventListener("click", connect);
    document.getElementById("send").addEventListener("click", displayText("HELLO", MAXWIDTH, MAXHEIGHT));

    // displayText("HELLO", MAXWIDTH, MAXHEIGHT);
</script>
</body>
</html>
