<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flippy V1 Web Controller</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>FlipDot Controller</h1>

  <div class="control">
    <label>USB Port:</label>
    <select id="portSelect"></select>
    <button id="connect">Connect</button>
  </div>

  <div class="control">
    <label>Address:</label>
    <input type="number" id="address" value="1" min="1" />
  </div>

  <div class="control">
    <label>Width:</label>
    <input type="number" id="width" value="96" min="1" />
    <label>Height:</label>
    <input type="number" id="height" value="16" min="1" />
  </div>

  <div class="control">
    <input type="text" id="textInput" placeholder="Type message" />
    <button id="send">Send</button>
  </div>

  <pre id="status">Status: Not connected</pre>

  <script type="module">
    import { erase, place, convert, tiny } from './flipHelpers.js';
    import { displayMain } from './display.js';

    let port;
    let writer;

    /** List previously granted ports */
    async function listPorts() {
        const ports = await navigator.serial.getPorts();
        const portSelect = document.getElementById("portSelect");
        portSelect.innerHTML = "";

        ports.forEach((p, i) => {
            const option = document.createElement("option");
            const info = p.getInfo();
            option.value = i;
            option.textContent = info.usbVendorId
                ? `Vendor:${info.usbVendorId} Product:${info.usbProductId || ""}`
                : "Unknown port";
            portSelect.appendChild(option);
        });

        if (ports.length > 0) {
            port = ports[0]; // default selection
        }
    }

    /** Request a new port from the user */
    async function requestNewPort() {
        try {
            port = await navigator.serial.requestPort({
                filters: [{ usbVendorId: 0x10c4 }] // optional filter
            });
            await openPort();
            await listPorts(); // refresh list
        } catch (err) {
            console.error(err);
            document.getElementById("status").textContent = "Error: " + err;
        }
    }

    /** Open the selected port */
    async function openPort() {
        if (!port) return;
        await port.open({ baudRate: 4800 });
        writer = port.writable.getWriter();
        document.getElementById("status").textContent = "Status: Connected!";
    }

    /** Handle selection from dropdown */
    document.getElementById("portSelect").addEventListener("change", async (e) => {
        const ports = await navigator.serial.getPorts();
        port = ports[e.target.value];
        if (port) await openPort();
    });

    /** Connect button triggers requestPort */
    document.getElementById("connect").addEventListener("click", requestNewPort);

    /** Display text on the FlipDot */
    document.getElementById("send").addEventListener("click", async () => {
        const text = document.getElementById("textInput").value;
        const width = parseInt(document.getElementById("width").value, 10);
        const height = parseInt(document.getElementById("height").value, 10);
        const address = parseInt(document.getElementById("address").value, 10);

        if (!port || !writer) {
            alert("Please connect to a port first!");
            return;
        }

        let flippy = erase(width, height);
        const matrix = tiny(text);
        flippy = place(flippy, matrix, [0, 4], false, width, height);
        await displayMain(flippy, address);
    });

    window.addEventListener("load", listPorts);
</script>

</body>
</html>
